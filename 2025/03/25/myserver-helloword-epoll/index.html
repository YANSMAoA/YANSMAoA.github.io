<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>myserver-helloword-epoll | Ysmmm的快乐小屋</title><meta name="author" content="Ysmmm"><meta name="copyright" content="Ysmmm"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="I&#x2F;OI&#x2F;O模型是是操作系统中处理输⼊输出操作的⼀种机制。它描述了应⽤程序如何与操作系统内核交互，以完成对外部设备（如⽹络、磁盘等）的数据读写操作。I&#x2F;O 操作通常是阻塞的，可能导致应⽤程序等待数据的到来或传输完成，进⽽影响性能。I&#x2F;O 操作⼀般分为两个阶段： 等待数据准备就绪： 外部设备与内核交互：当应⽤程序请求 I&#x2F;O 操作时（例如，读取⽂件或">
<meta property="og:type" content="article">
<meta property="og:title" content="myserver-helloword-epoll">
<meta property="og:url" content="https://yansmaoa.github.io/2025/03/25/myserver-helloword-epoll/index.html">
<meta property="og:site_name" content="Ysmmm的快乐小屋">
<meta property="og:description" content="I&#x2F;OI&#x2F;O模型是是操作系统中处理输⼊输出操作的⼀种机制。它描述了应⽤程序如何与操作系统内核交互，以完成对外部设备（如⽹络、磁盘等）的数据读写操作。I&#x2F;O 操作通常是阻塞的，可能导致应⽤程序等待数据的到来或传输完成，进⽽影响性能。I&#x2F;O 操作⼀般分为两个阶段： 等待数据准备就绪： 外部设备与内核交互：当应⽤程序请求 I&#x2F;O 操作时（例如，读取⽂件或">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yansmaoa.github.io/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg">
<meta property="article:published_time" content="2025-03-25T06:21:27.000Z">
<meta property="article:modified_time" content="2025-03-25T08:12:56.590Z">
<meta property="article:author" content="Ysmmm">
<meta property="article:tag" content="server">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yansmaoa.github.io/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg"><link rel="shortcut icon" href="/img/jinke.png"><link rel="canonical" href="https://yansmaoa.github.io/2025/03/25/myserver-helloword-epoll/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'myserver-helloword-epoll',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-25 16:12:56'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/saierda.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">59</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Ysmmm的快乐小屋"><span class="site-name">Ysmmm的快乐小屋</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">myserver-helloword-epoll</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-25T06:21:27.000Z" title="发表于 2025-03-25 14:21:27">2025-03-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-25T08:12:56.590Z" title="更新于 2025-03-25 16:12:56">2025-03-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>25分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="myserver-helloword-epoll"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="I-O"><a href="#I-O" class="headerlink" title="I&#x2F;O"></a>I&#x2F;O</h1><p>I&#x2F;O模型是是操作系统中处理输⼊输出操作的⼀种机制。它描述了应⽤程序如何与操作系统内核交互，以完成对外部设备（如⽹络、磁盘等）的数据读写操作。I&#x2F;O 操作通常是阻塞的，可能导致应⽤程序等待数据的到来或传输完成，进⽽影响性能。<br><strong>I&#x2F;O 操作⼀般分为两个阶段：</strong></p>
<h2 id="等待数据准备就绪："><a href="#等待数据准备就绪：" class="headerlink" title="等待数据准备就绪："></a>等待数据准备就绪：</h2><ul>
<li>外部设备与内核交互：当应⽤程序请求 I&#x2F;O 操作时（例如，读取⽂件或接收⽹络数据），外部设备会将数据传输到操作系统内核中的缓冲区。</li>
<li>等待数据到达：在⽹络 I&#x2F;O 中，内核可能需要等待⽹络接⼝控制器（NIC）接收数据包，将数据包放⼊⽹络缓冲区中；在磁盘 I&#x2F;O 中，内核则需要等待磁盘驱动器将数据加载到内核的磁盘缓冲区中。等待时间取决于设备的响应速度。</li>
<li>阻塞和⾮阻塞 I&#x2F;O：应⽤程序发起请求后，如果采⽤阻塞 I&#x2F;O，应⽤程序会暂停执⾏，等待数据到达；如果采⽤⾮阻塞 I&#x2F;O，应⽤程序在等待数据期间可以继续执⾏其他操作。内核会持续检查数据是否到达缓冲区。</li>
</ul>
<h2 id="将数据从内核空间复制到⽤⼾空间："><a href="#将数据从内核空间复制到⽤⼾空间：" class="headerlink" title="将数据从内核空间复制到⽤⼾空间："></a>将数据从内核空间复制到⽤⼾空间：</h2><ul>
<li>内核和⽤⼾空间的分离：现代操作系统中，内存空间通常分为内核空间和⽤⼾空间。内核空间具有更⾼的权限和安全性，⽽⽤⼾空间则为应⽤程序所⽤。为了保证安全，应⽤程序不能直接访问内核空间的数据。</li>
<li>数据拷⻉：当数据到达内核缓冲区且准备好后，内核会将数据从内核空间复制到应⽤程序的⽤⼾空间缓冲区中。这个过程称为数据拷⻉。</li>
<li>效率问题：这种数据拷⻉增加了 I&#x2F;O 操作的开销，因为数据在⽤⼾空间和内核空间之间传输可能会涉及上下⽂切换和数据复制。⼀些优化⽅式（如零拷⻉）可以减少这种开销。</li>
</ul>
<h2 id="I-O-操作的整体流程"><a href="#I-O-操作的整体流程" class="headerlink" title="I&#x2F;O 操作的整体流程"></a>I&#x2F;O 操作的整体流程</h2><ol>
<li>应⽤程序发起 I&#x2F;O 请求：应⽤程序向操作系统发出读取或接收数据的请求（如 read() 或recv() ）。</li>
<li>数据进⼊内核缓冲区：外部设备（⽹络、磁盘等）将数据传输到内核空间的缓冲区中，此时需要等待数据到达。</li>
<li>检查数据是否就绪：操作系统通过设备驱动和中断机制通知内核数据已就绪。</li>
<li>数据拷⻉到⽤⼾空间：数据到达内核缓冲区后，内核将数据从内核缓冲区复制到应⽤程序的⽤⼾空间缓冲区。</li>
<li>通知应⽤程序：数据传输完成后，操作系统通知应⽤程序可以读取⽤⼾空间中的数据，I&#x2F;O 操作结束。</li>
</ol>
<h1 id="优化⽅式：零拷⻉"><a href="#优化⽅式：零拷⻉" class="headerlink" title="优化⽅式：零拷⻉"></a>优化⽅式：零拷⻉</h1><p>为了减少 I&#x2F;O 操作中的数据拷⻉次数，许多现代系统引⼊了零拷⻉（zero-copy） 技术。这种⽅式通过<br>直接将数据从内核缓冲区传输到⽹络接⼝或磁盘接⼝，减少了内核空间到⽤⼾空间的拷⻉操作，提⾼了传输效率。</p>
<h2 id="硬盘和⽹络速度慢于内存和-CPU："><a href="#硬盘和⽹络速度慢于内存和-CPU：" class="headerlink" title="硬盘和⽹络速度慢于内存和 CPU："></a>硬盘和⽹络速度慢于内存和 CPU：</h2><ol>
<li>磁盘 I&#x2F;O 慢：硬盘读取和写⼊数据的速度远远低于内存和 CPU 的处理速度，尤其是机械硬盘（HDD）。即使是速度较快的固态硬盘（SSD），其读写速度也⽐内存和 CPU 慢很多。</li>
<li>⽹络 I&#x2F;O 慢：⽹络数据的发送和接收涉及路由、传输和协议处理，可能会经过多次中间传输。即使在局域⽹环境下，⽹络数据的传输速度也⽐内存或 CPU 处理速度要慢。</li>
</ol>
<h2 id="对⽐分析"><a href="#对⽐分析" class="headerlink" title="对⽐分析"></a>对⽐分析</h2><ol>
<li>CPU 处理：⼀般是最迅速的，时间在纳秒级别（1 纳秒 &#x3D; 10^-9 秒），可以快速完成请求准备和响应处理。通常只是⼏微秒或更短时间。</li>
<li>内存操作：内存的读取和写⼊速度⽐磁盘快得多，通常在⼏⼗纳秒到⼏百纳秒。它的速度⼤约是 CPU的⼏⼗倍慢，但仍然⽐ I&#x2F;O 快很多。</li>
<li>⽹络 I&#x2F;O：互联⽹请求中最耗时的部分通常是⽹络 I&#x2F;O，包括 DNS 查询、建⽴ TCP 连接、发送和接收HTTP 请求与响应。由于涉及⽹络传输、协议处理等，这些操作通常需要数⼗到数百毫秒（1 毫秒 &#x3D;10^-3 秒）。⽹络延迟和带宽限制是影响⽹络 I&#x2F;O 时间的主要因素。</li>
<li>磁盘 I&#x2F;O：磁盘读取在 SSD 上可能需要⼏毫秒，⽽在机械硬盘（HDD）上可能需要⼏⼗毫秒。磁盘速度⽐内存慢很多，特别是机械硬盘，因为存在机械运动的寻道时间和旋转延迟。</li>
</ol>
<h1 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h1><h2 id="套接字-Socket-："><a href="#套接字-Socket-：" class="headerlink" title="套接字 (Socket)："></a>套接字 (Socket)：</h2><ul>
<li>套接字是进程间通信（IPC）和⽹络通信的基本抽象。在Linux系统中，创建套接字后，会得到⼀个⽂件描述符（file descriptor），它是进程访问⽹络资源的句柄句柄（Handle）在计算机科学中是⼀个抽象的概念，它代表了⼀个对系统资源（如⽂件、窗⼝、数据库连接、⽹络套接字等）的唯⼀标识符。句柄不是⼀个实际的数据值，⽽是⼀个指向系统内部分配给特定资源的数据结构或对象的引⽤。通过句柄，应⽤程序可以间接地访问和控制这些资源，⽽不是直接操作底层资源的具体地址。</li>
</ul>
<h2 id="进程上下⽂切换："><a href="#进程上下⽂切换：" class="headerlink" title="进程上下⽂切换："></a>进程上下⽂切换：</h2><ul>
<li>在不同的I&#x2F;O模型中，可能涉及进程上下⽂切换。例如，在阻塞I&#x2F;O模型中，当进程被I&#x2F;O操作阻塞时，操作系统可能会挂起当前进程并调度其他进程运⾏；⽽在异步I&#x2F;O或⾮阻塞I&#x2F;O模型中，进程能够更⾼效地利⽤CPU时间，减少不必要的上下⽂切换。进程上下⽂切换（Process Context Switch）是指操作系统在多任务环境下，从⼀个进程的执⾏环境（即上下⽂）切换到另⼀个进程的执⾏环境的过程。具体来说：当CPU需要暂停当前正在运⾏的进程转⽽执⾏另⼀个进程时，操作系统必须做以下⼏件事情：<ol>
<li>保存当前进程的状态：包括程序计数器（PC，指⽰下⼀条要执⾏的指令地址）、寄存器状态、内存管理信息（如⻚表指针）、打开的⽂件描述符、信号处理设置等所有相关资源和状态。</li>
<li>恢复下⼀个进程的状态：将被选中要运⾏的下⼀个进程的上下⽂信息从进程控制块（PCB,Process Control Block）中取出，并加载到相应的处理器寄存器和内存管理单元中。</li>
<li>切换线程调度策略决定的进程：根据操作系统的调度策略（如时间⽚轮转、优先级调度等），选择⼀个新的进程来执⾏。这个过程涉及到内核态与⽤⼾态之间的转换，如果新进程是从⽤⼾态切换过来的，还需要通过系统调⽤返回到⽤⼾态并开始执⾏新的进程代码。<br>上下⽂切换开销较⼤，因为它涉及到了对硬件状态的保存和恢复以及可能的内存交换（如果涉及到虚拟内存且有⻚⾯不在物理内存中）。频繁的上下⽂切换会消耗⼤量的CPU时间，降低系统的整体性能。因此，在设计和优化多进程或多线程应⽤程序时，应尽量减少不必要的上下⽂切换。</li>
</ol>
</li>
</ul>
<h2 id="缓冲区管理："><a href="#缓冲区管理：" class="headerlink" title="缓冲区管理："></a>缓冲区管理：</h2><ul>
<li>内核维护着⽤于存储⽹络数据的缓冲区。当⽹络数据到达时，先放⼊内核空间的缓冲区，然后根据I&#x2F;O模型的不同策略，决定何时以及如何将数据复制到⽤⼾空间的缓冲区供进程使⽤，或者反之，将进程要发送的数据从⽤⼾空间复制到内核空间的缓冲区，再由内核发送出去。</li>
</ul>
<h2 id="事件通知机制："><a href="#事件通知机制：" class="headerlink" title="事件通知机制："></a>事件通知机制：</h2><ul>
<li>对于信号驱动I&#x2F;O和异步I&#x2F;O，内核通过特定机制通知进程数据已准备就绪。在信号驱动I&#x2F;O中，是通过发送信号；在异步I&#x2F;O中，则可能是通过完成队列或回调函数。</li>
</ul>
<h1 id="常⻅的五种I-O模型"><a href="#常⻅的五种I-O模型" class="headerlink" title="常⻅的五种I&#x2F;O模型"></a>常⻅的五种I&#x2F;O模型</h1><p>Unix⽹络编程中，经典地提出了五种I&#x2F;O模型，它们分别是：</p>
<ul>
<li>阻塞I&#x2F;O（Blocking I&#x2F;O）</li>
<li>⾮阻塞I&#x2F;O（Non-blocking I&#x2F;O）</li>
<li>I&#x2F;O多路复⽤（I&#x2F;O Multiplexing）</li>
<li>信号驱动I&#x2F;O（Signal-driven I&#x2F;O）</li>
<li>异步I&#x2F;O（Asynchronous I&#x2F;O）</li>
</ul>
<h1 id="事件驱动模型"><a href="#事件驱动模型" class="headerlink" title="事件驱动模型"></a>事件驱动模型</h1><h2 id="事件驱动模型定义"><a href="#事件驱动模型定义" class="headerlink" title="事件驱动模型定义"></a>事件驱动模型定义</h2><p><strong>事件驱动模型是⼀种编程范式，服务器在这种模型下通过监听事件来驱动程序运⾏，⽽不是顺序执</strong>⾏或者等待某个操作完成。这些事件通常包括⽹络IO事件（如可读、可写），定时器事件等。上述这五种模型主要描述的是操作系统如何管理和调度进程与I&#x2F;O设备之间的交互。它们都涉及到⽹络编程中读写数据时进程状态的变化以及对系统调⽤的响应⽅式。</p>
<h2 id="事件驱动下的服务器处理流程"><a href="#事件驱动下的服务器处理流程" class="headerlink" title="事件驱动下的服务器处理流程"></a>事件驱动下的服务器处理流程</h2><p>在事件驱动模型中，服务器处理客⼾端请求的过程正是利⽤事件循环和⾮阻塞 I&#x2F;O 来避免阻塞，提⾼并发和效率。可以具体分解如下：</p>
<ul>
<li>新连接的可读事件：当服务器主线程监听到有新的连接到来时（通常通过 accept 系统调⽤），这个连接的可读事件（表⽰有数据可读）会被触发。此时，服务器不会⽴即阻塞等待数据，⽽是将这个事件注册到事件循环中，通常是通过 I&#x2F;O 多路复⽤机制（如 epoll、select、kqueue）。</li>
<li>异步读取数据：注册好事件后，服务器主线程会⽴即返回，继续监听其他事件或处理其他任务。与此同时，内核负责从⽹络设备读取数据（⽹络数据从⽹卡进⼊服务器），直到数据准备好被读取。这种设计确保了主线程不会阻塞在等待⽹络数据上，⽽是继续执⾏其他请求或任务。事件准备好加⼊就绪列表：当数据从⽹络设备到达并被读⼊到内核缓冲区时，内核会通知事件循环（通过 epoll_wait 等），将这个连接的事件放⼊就绪列表。这个时候，事件循环会检测到该事件已经准备好，可以开始处理。</li>
<li>服务器处理数据：服务器主线程从就绪列表中取出事件，然后通过⾮阻塞 I&#x2F;O 函数（如 read 或 recv）读取内核缓冲区的数据，并进⾏处理（例如解析 HTTP 请求、查询数据库、⽣成响应等）。</li>
<li>核⼼优势：避免等待 I&#x2F;O 完成的过程。这个流程的核⼼优势在于，服务器不⽤等待从⽹络数据区（⽹卡）读取到内核缓冲区的过程。主线程在等待期间可以正常执⾏其他任务（如处理其他连接、维护⼼跳、后台任务等），只有在数据准备好后才开始读取和处理，从⽽⼤⼤提⾼了服务器的并发性能和资源利⽤率。</li>
</ul>
<h2 id="技术层⾯解释（重要理解，能讲清楚事件驱动的逻辑）"><a href="#技术层⾯解释（重要理解，能讲清楚事件驱动的逻辑）" class="headerlink" title="技术层⾯解释（重要理解，能讲清楚事件驱动的逻辑）"></a>技术层⾯解释（重要理解，能讲清楚事件驱动的逻辑）</h2><p>假设有⼀个简单的事件驱动型Web服务器，采⽤单线程模型处理客⼾端请求。服务器创建⼀个主循环<br>（事件循环），并设置为监听套接字的读就绪事件。</p>
<ol>
<li>初始化阶段：</li>
</ol>
<ul>
<li>服务器启动时，⾸先创建⼀个监听套接字并将其设置为⾮阻塞模式。</li>
<li>然后将监听套接字注册到事件循环中，以便在有新的客⼾端连接请求时收到通知。</li>
</ul>
<ol start="2">
<li>事件循环：</li>
</ol>
<ul>
<li>主线程进⼊事件循环，调⽤系统提供的I&#x2F;O复⽤函数如 epoll_wait() （Linux）或kqueue() （BSD系统）等，这些函数会阻塞等待指定⽂件描述符集合上的事件发⽣。</li>
<li>当有新客⼾端连接请求（即监听套接字变为可读状态），事件循环⽴即返回，并得到⼀个表⽰已就绪的⽂件描述符列表。</li>
</ul>
<ol start="3">
<li>事件处理：</li>
</ol>
<ul>
<li>对于每⼀个就绪的⽂件描述符，事件循环调⽤相应的回调函数来处理事件。<ul>
<li>如果是监听套接字，那么事件处理器可能执⾏ accept() 接受新的连接，并为新连接创建⼀个新的⾮阻塞套接字，同时将新套接字也注册到事件循环中监听读写事件。</li>
<li>如果是已连接的客⼾端套接字，事件处理器可能是读取请求数据，解析HTTP请求头和正⽂，然后调⽤处理请求的回调函数，该函数⽣成响应并将其写⼊相应套接字。</li>
</ul>
</li>
</ul>
<ol start="4">
<li>异步IO操作：</li>
</ol>
<ul>
<li>在整个过程中，所有⽹络I&#x2F;O都是⾮阻塞的，例如读取客⼾端数据时，如果当前没有⾜够的数据可供读取， read() 不会阻塞⽽是⽴刻返回，事件循环继续检查其他待处理的事件。</li>
<li>当有数据写⼊客⼾端时，同样使⽤⾮阻塞的 write() 调⽤，若不能⼀次性写出全部数据，则下次事件循环迭代时再次尝试写⼊。</li>
<li>通过这种⽅式，事件驱动型线程可以在单个线程内⾼效地并发处理多个客⼾端连接，每个客⼾端的请求、响应过程都变成了独⽴的事件，由事件循环统⼀调度管理，⽽不是为每个客⼾端创建单独的线程或进程，从⽽降低了资源消耗，提⾼了系统的并发能⼒</li>
</ul>
<h2 id="epoll原理详细解释"><a href="#epoll原理详细解释" class="headerlink" title="epoll原理详细解释"></a>epoll原理详细解释</h2><h3 id="⽤⼾态和内核态"><a href="#⽤⼾态和内核态" class="headerlink" title="⽤⼾态和内核态"></a>⽤⼾态和内核态</h3><ol>
<li>⽤⼾态（User Mode）：</li>
</ol>
<ul>
<li>⽤⼾态是指操作系统中的⼀种运⾏模式，通常是指⽤⼾应⽤程序运⾏的环境。</li>
<li>在⽤⼾态下，应⽤程序只能访问有限的资源和执⾏有限的操作，例如⽂件读写、⽹络通信等。</li>
<li>应⽤程序运⾏在⽤⼾态时，它们不能直接访问底层硬件资源或进⾏特权操作。</li>
<li>⽤⼾态下的程序执⾏受到严格的权限控制，以确保它们不能⼲扰操作系统的正常运⾏。</li>
</ul>
<ol start="2">
<li>内核态（Kernel Mode）：</li>
</ol>
<ul>
<li>内核态是操作系统的核⼼运⾏模式，也被称为特权模式。</li>
<li>在内核态下，操作系统内核具有最⾼的权限，可以访问所有的硬件资源和执⾏所有特权操作。</li>
<li>内核态下的代码能够执⾏关键的系统管理任务，如进程管理、内存管理、设备驱动程序等。</li>
<li>操作系统内核通常运⾏在内核态下，以便执⾏系统级任务并提供服务给⽤⼾态的应⽤程序。</li>
</ul>
<h3 id="epoll⼯作原理"><a href="#epoll⼯作原理" class="headerlink" title="epoll⼯作原理"></a>epoll⼯作原理</h3><ul>
<li>Linux特有的IO多路复⽤机制：epoll是专⻔为Linux系统设计的⼀种⾼效的IO多路复⽤技术。它通过⼀个⽂件描述符来跟踪和管理多个socket。</li>
<li>⽂件描述符管理：在epoll模型中，所有需要监视的socket都会被加⼊到⼀个由epoll实例管理的内部数据结构中。这个实例由⼀个⽂件描述符代表，通过这个描述符可以对这些socket进⾏各种操作。</li>
<li>系统调⽤：使⽤ epoll_wait 等系统调⽤，可以询问epoll实例哪些socket处于就绪状态，即准备好执⾏读取、写⼊或其他操作。</li>
</ul>
<h3 id="epoll的模式"><a href="#epoll的模式" class="headerlink" title="epoll的模式"></a>epoll的模式</h3><ul>
<li>LT（⽔平触发）模式：<ul>
<li>在此模式下，只要满⾜某个条件（例如，有数据可读），epoll就会不断地通知应⽤程序，直到该事件被处理。</li>
<li>⽔平触发模式更容易理解和使⽤，但在⾼负载情况下可能会导致性能问题。</li>
</ul>
</li>
<li>ET（边缘触发）模式：<ul>
<li>边缘触发模式只在被监视的socket状态发⽣变化时（例如，从⽆数据到有数据）通知应⽤程序⼀次。</li>
<li>这种模式通常更⾼效，因为它减少了事件通知的次数，但处理起来更复杂。</li>
</ul>
</li>
</ul>
<h3 id="epoll-使⽤的主要数据结构："><a href="#epoll-使⽤的主要数据结构：" class="headerlink" title="epoll 使⽤的主要数据结构："></a>epoll 使⽤的主要数据结构：</h3><ul>
<li>红⿊树：epoll 内部使⽤⼀种称为红⿊树的平衡⼆叉搜索树来存储所有注册的⽂件描述（socket）。每个节点代表⼀个⽂件描述符及其相关的事件和数据。红⿊树保证了插⼊、除和查找操作的⾼效性，即使在管理成千上万的⽂件描述符时也能保持⾼效。</li>
<li>就绪列表：当某个⽂件描述符上的事件就绪（如可读或可写）时，它会被添加到⼀个就绪列表中。这个列表仅包含那些状态发⽣变化，需要处理的⽂件描述符。</li>
</ul>
<h2 id="epoll实例（理解-能复述）"><a href="#epoll实例（理解-能复述）" class="headerlink" title="epoll实例（理解+能复述）"></a><strong>epoll实例（理解+能复述）</strong></h2><h3 id="创建epoll实例"><a href="#创建epoll实例" class="headerlink" title="创建epoll实例"></a>创建epoll实例</h3><ul>
<li>创建epoll实例代码<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> epollfd = <span class="built_in">epoll_create1</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure></li>
<li>这⾏代码创建⼀个epoll实例，⽤于后续管理socket的事件。 epoll_create1(0) 是创建epoll实例的系统调⽤，其中的 0 表⽰没有特殊的标志。</li>
<li>epoll_create1 会向操作系统请求创建⼀个新的epoll句柄。</li>
<li>函数返回的 epollfd 是⼀个有效的⽂件描述符，它代表了这个新创建的epoll实例，类似于打开⼀个⽂件或创建⼀个socket时得到的⽂件描述符。</li>
<li>这个epoll实例就像是⼀个事件表或者容器，可以添加、删除或查询关注的⽂件描述符及其发⽣的事件类型。</li>
<li>参数 0 意味着不设置任何标志，特别是没有指定 EPOLL_CLOEXEC 标记，这意味着该epoll句柄不会在执⾏exec系列系统调⽤时⾃动关闭。</li>
</ul>
<h3 id="设置⾮阻塞socket"><a href="#设置⾮阻塞socket" class="headerlink" title="设置⾮阻塞socket"></a>设置⾮阻塞socket</h3><p>• 设置⾮阻塞的代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setNonBlocking</span>(server_fd);</span><br></pre></td></tr></table></figure>
<ul>
<li>将socket设置为⾮阻塞意味着在进⾏读写操作时，如果没有数据或者不能⽴即发送数据，操作会⽴即返回⽽不是挂起等待，这是实现⾼效事件驱动模型的关键。</li>
<li>这个函数调⽤将服务器 socket server_fd 设置为⾮阻塞模式。在⾮阻塞模式下，IO 操作（如读、写）将不会导致线程挂起等待操作完成，⽽是⽴即返回，从⽽使服务器能够在等待数据时继续处理其他任务。</li>
</ul>
<h3 id="注册事件到epoll"><a href="#注册事件到epoll" class="headerlink" title="注册事件到epoll"></a>注册事件到epoll</h3><ul>
<li><p>注册事件代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">ev.events = EPOLLIN | EPOLLET;</span><br><span class="line">ev.data.fd = server_fd;</span><br><span class="line"><span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, server_fd, &amp;ev);</span><br></pre></td></tr></table></figure>
<p>通过 epoll_ctl 将socket注册到epoll实例中，并指定关注的事件类型。这⾥的 EPOLLIN表⽰关注可读事件， EPOLLET 表⽰使⽤边缘触发模式。epoll_ctl 函数</p>
</li>
<li><p>Linux系统中⽤于操作epoll实例的接⼝，它可以执⾏以下三种不同的操作：</p>
</li>
</ul>
<ol>
<li>EPOLL_CTL_ADD<ul>
<li>作⽤：向epoll实例中添加⼀个⽂件描述符，并注册要监控的事件类型。</li>
<li>语法：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event *event)</span></span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<ul>
<li>在这个操作中，op应设为 EPOLL_CTL_ADD ，fd参数是你想要添加到epoll实例中的⽂件描述符（例如socket），event指向⼀个已初始化好的 epoll_event 结构体，其中包含了你希望在该⽂件描述符上监听的事件。</li>
</ul>
<ol start="2">
<li>EPOLL_CTL_MOD<ul>
<li>作⽤：修改已经添加到epoll实例中的⽂件描述符所对应的事件类型。</li>
<li>当需要更改某个已监控的⽂件描述符上的事件时，可以使⽤此操作码。这通常⽤于动态改变对特定⽂件描述符的事件关注类型，⽽不需要先删除再重新添加。</li>
</ul>
</li>
<li>EPOLL_CTL_DEL<ul>
<li>作⽤：从epoll实例中删除⼀个之前添加过的⽂件描述符，停⽌监控其事件。</li>
<li>当不再需要监控某个⽂件描述符上的事件时，可以调⽤此操作来释放资源。之后对于该⽂件描述符发⽣的相应事件，epoll_wait将不会再返回相关信息。</li>
</ul>
</li>
</ol>
<h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><ul>
<li>事件循环代码<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="type">int</span> nfds = <span class="built_in">epoll_wait</span>(epollfd, events, MAX_EVENTS, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> n = <span class="number">0</span>; n &lt; nfds; ++n) &#123;</span><br><span class="line">        <span class="comment">// 处理事件</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使⽤<code>epoll_wait</code>等待事件的发⽣，它会阻塞直到有事件发⽣，然后处理这些事件。这是事件驱动模型中循环监听并处理事件的关键部分。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event *events, <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure>
参数详解：</li>
<li>int epfd ：这是通过调⽤ epoll_create() 或 epoll_create1() 创建的epoll实例的⽂件描述符。</li>
<li>struct epoll_event *events ：这是⼀个⽤⼾空间预先分配好的数组，⽤来接收由内核复制过来的已发⽣的事件结构体。每个结构体包含了触发事件的⽂件描述符及其相关的事件类型（例如读就绪、写就绪等）。</li>
<li>int maxevents ：此参数指定了 events 数组可以接收的最⼤事件数量。当有多个⽂件描述符同时准备好时， epoll_wait() 最多会填充这么多数量的事件到数组中。</li>
<li>int timeout ：等待时间（以毫秒为单位）。该值指定 epoll_wait() 函数阻塞的最⻓时间：◦ 若设置为 -1 ，表⽰将⽆限期地等待事件发⽣，即函数直到有⾄少⼀个事件发⽣才会返回。</li>
<li>若设置为 0 ，则 epoll_wait() 将⽴即返回，⽆论是否有待处理的事件，这通常⽤于⾮阻塞模式。</li>
<li>若设置为⼤于 0 的值，则函数最多会阻塞等待指定的毫秒数，即使在这段时间内没有事件发⽣也会返回。<br>处理新的连接请求和IO事件<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (events[n].data.fd == server_fd) &#123;</span><br><span class="line">    <span class="comment">// 处理新连接</span></span><br><span class="line">    new_socket = <span class="built_in">accept</span>(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;address,(<span class="type">socklen_t</span>*)&amp;addrlen);</span><br><span class="line">    <span class="built_in">setNonBlocking</span>(new_socket); <span class="comment">// 设置新连接为⾮阻塞模式</span></span><br><span class="line">    ev.events = EPOLLIN | EPOLLET; <span class="comment">// 监听新连接的可读事件和边缘触发</span></span><br><span class="line">    ev.data.fd = new_socket;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, new_socket, &amp;ev) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;epoll_ctl: new_socket&quot;</span>); <span class="comment">// 注册新连接事件失败，记录错误⽇志</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span>处理已连接socket的IO事件</span></span><br><span class="line"><span class="comment">// ... (读取请求，处理请求，发送响应) ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>事件循环中，根据⽂件描述符判断事件类型：若为服务器 socket server_fd ，则表⽰有新的连接请求；否则，为已建⽴连接的 socket 上的 IO 事件。对于新连接，使⽤ accept 接受连接，设置为⾮阻塞，并将其注册到 epoll 实例中</li>
</ul>
<h3 id="资源管理和错误处理"><a href="#资源管理和错误处理" class="headerlink" title="资源管理和错误处理"></a>资源管理和错误处理</h3><ul>
<li>重要性<ul>
<li>在服务器编程中，正确的资源管理和错误处理是⾮常关键的。这包括在出错时释放资源，以及确保在连接关闭时，从epoll实例中移除socket并关闭它们。</li>
</ul>
</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Logger.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Database.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 8080</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EVENTS 100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> RequestHandler = std::function&lt;std::<span class="built_in">string</span>(<span class="type">const</span> std::string&amp;)&gt;;</span><br><span class="line"></span><br><span class="line">std::map&lt;std::string, RequestHandler&gt; get_routes;</span><br><span class="line">std::map&lt;std::string, RequestHandler&gt; post_routes;</span><br><span class="line"><span class="function">Database <span class="title">db</span><span class="params">(<span class="string">&quot;users.db&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 然后在 parseFormBody 函数中使用它</span></span><br><span class="line"><span class="function">std::map&lt;std::string, std::string&gt; <span class="title">parseFormBody</span><span class="params">(<span class="type">const</span> std::string&amp; body)</span> </span>&#123;</span><br><span class="line">    std::map&lt;std::string, std::string&gt; params;</span><br><span class="line">    <span class="function">std::istringstream <span class="title">stream</span><span class="params">(body)</span></span>;</span><br><span class="line">    std::string pair;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Parsing body: %s&quot;</span> , body.<span class="built_in">c_str</span>());  <span class="comment">// 记录原始body数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (std::<span class="built_in">getline</span>(stream, pair, <span class="string">&#x27;&amp;&#x27;</span>)) &#123;</span><br><span class="line">        std::string::size_type pos = pair.<span class="built_in">find</span>(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (pos != std::string::npos) &#123;</span><br><span class="line">            std::string key = pair.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">            std::string value = pair.<span class="built_in">substr</span>(pos + <span class="number">1</span>);</span><br><span class="line">            params[key] = value;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Parsed key-value pair: %s = %s&quot;</span> ,key.<span class="built_in">c_str</span>(), value.<span class="built_in">c_str</span>());  <span class="comment">// 记录每个解析出的键值对</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 错误处理：找不到 &#x27;=&#x27; 分隔符</span></span><br><span class="line">            std::string error_msg = <span class="string">&quot;Error parsing: &quot;</span> + pair;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(error_msg.<span class="built_in">c_str</span>());  <span class="comment">// 记录错误信息</span></span><br><span class="line">            std::cerr &lt;&lt; error_msg &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化路由表</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setupRoutes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Setting up routes&quot;</span>);  <span class="comment">// 记录路由设置</span></span><br><span class="line">    <span class="comment">// GET请求处理</span></span><br><span class="line">    get_routes[<span class="string">&quot;/&quot;</span>] = [](<span class="type">const</span> std::string&amp; request) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    get_routes[<span class="string">&quot;/register&quot;</span>] = [](<span class="type">const</span> std::string&amp; request) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 实现用户注册逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Please use POST to register&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    get_routes[<span class="string">&quot;/login&quot;</span>] = [](<span class="type">const</span> std::string&amp; request) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 实现用户登录逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Please use POST to login&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改POST路由逻辑</span></span><br><span class="line">    post_routes[<span class="string">&quot;/register&quot;</span>] = [](<span class="type">const</span> std::string&amp; request) &#123;</span><br><span class="line">        <span class="comment">// 解析用户名和密码</span></span><br><span class="line">        <span class="comment">// 例如从请求中解析 username 和 password，这里需要您自己实现解析逻辑</span></span><br><span class="line">        <span class="keyword">auto</span> params = <span class="built_in">parseFormBody</span>(request);</span><br><span class="line">        std::string username = params[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">        std::string password = params[<span class="string">&quot;password&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用数据库方法进行注册</span></span><br><span class="line">        <span class="keyword">if</span> (db.<span class="built_in">registerUser</span>(username, password)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register Success!&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register Failed!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 登录路由</span></span><br><span class="line">    post_routes[<span class="string">&quot;/login&quot;</span>] = [](<span class="type">const</span> std::string&amp; request) &#123;</span><br><span class="line">        <span class="comment">// 解析用户名和密码</span></span><br><span class="line">        <span class="keyword">auto</span> params = <span class="built_in">parseFormBody</span>(request);</span><br><span class="line">        std::string username = params[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">        std::string password = params[<span class="string">&quot;password&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用数据库方法进行登录</span></span><br><span class="line">        <span class="keyword">if</span> (db.<span class="built_in">loginUser</span>(username, password)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login Success!&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login Failed!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">     <span class="comment">// <span class="doctag">TODO:</span> 添加其他路径和处理函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">std::tuple&lt;std::string, std::string, std::string&gt; <span class="title">parseHttpRequest</span><span class="params">(<span class="type">const</span> std::string&amp; request)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Parsing HTTP request&quot;</span>);  <span class="comment">// 记录请求解析</span></span><br><span class="line">    <span class="comment">// 解析请求方法和URI</span></span><br><span class="line">    <span class="type">size_t</span> method_end = request.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    std::string method = request.<span class="built_in">substr</span>(<span class="number">0</span>, method_end);</span><br><span class="line">    <span class="type">size_t</span> uri_end = request.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>, method_end + <span class="number">1</span>);</span><br><span class="line">    std::string uri = request.<span class="built_in">substr</span>(method_end + <span class="number">1</span>, uri_end - method_end - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提取请求体（对于POST请求）</span></span><br><span class="line">    std::string body;</span><br><span class="line">    <span class="keyword">if</span> (method == <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">        <span class="type">size_t</span> body_start = request.<span class="built_in">find</span>(<span class="string">&quot;\r\n\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (body_start != std::string::npos) &#123;</span><br><span class="line">            body = request.<span class="built_in">substr</span>(body_start + <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;method, uri, body&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">handleHttpRequest</span><span class="params">(<span class="type">const</span> std::string&amp; method, <span class="type">const</span> std::string&amp; uri, <span class="type">const</span> std::string&amp; body)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Handling HTTP request for URI: %s&quot;</span> , uri.<span class="built_in">c_str</span>());  <span class="comment">// 记录请求处理</span></span><br><span class="line">    <span class="keyword">if</span> (method == <span class="string">&quot;GET&quot;</span> &amp;&amp; get_routes.<span class="built_in">count</span>(uri) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> get_routes[uri](body);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method == <span class="string">&quot;POST&quot;</span> &amp;&amp; post_routes.<span class="built_in">count</span>(uri) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> post_routes[uri](body);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;404 Not Found&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置非阻塞模式的函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setNonBlocking</span><span class="params">(<span class="type">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> opts = <span class="built_in">fcntl</span>(sock, F_GETFL); <span class="comment">// 获取文件描述符的状态标志</span></span><br><span class="line">    <span class="keyword">if</span> (opts &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;fcntl(F_GETFL) failed on socket %d: %s&quot;</span>, sock, <span class="built_in">strerror</span>(errno)); <span class="comment">// 记录详细错误信息</span></span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    opts |= O_NONBLOCK; <span class="comment">// 设置非阻塞标志</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(sock, F_SETFL, opts) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;fcntl(F_SETFL) failed on socket %d: %s&quot;</span>, sock, <span class="built_in">strerror</span>(errno)); <span class="comment">// 记录详细错误信息</span></span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Set socket %d to non-blocking&quot;</span>, sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理客户端请求的函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handleClientSocket</span><span class="params">(<span class="type">int</span> client_fd)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line">    std::string request;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取数据直到没有更多可读数据</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">ssize_t</span> bytes_read = <span class="built_in">read</span>(client_fd, buffer, <span class="built_in">sizeof</span>(buffer) - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (bytes_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            buffer[bytes_read] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            request += buffer;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytes_read == <span class="number">-1</span> &amp;&amp; (errno == EAGAIN || errno == EWOULDBLOCK)) &#123;</span><br><span class="line">            <span class="comment">// 没有更多数据可读，退出循环</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 发生错误或连接关闭</span></span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Read error or connection closed on fd %d&quot;</span>, client_fd);</span><br><span class="line">            <span class="built_in">close</span>(client_fd);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析并处理请求</span></span><br><span class="line">    <span class="keyword">if</span> (!request.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">auto</span> [method, uri, body] = <span class="built_in">parseHttpRequest</span>(request);</span><br><span class="line">        std::string response_body = <span class="built_in">handleHttpRequest</span>(method, uri, body);</span><br><span class="line">        std::string response = <span class="string">&quot;HTTP/1.1 200 OK\nContent-Type: text/plain\n\n&quot;</span> + response_body;</span><br><span class="line">        <span class="built_in">send</span>(client_fd, response.<span class="built_in">c_str</span>(), response.<span class="built_in">length</span>(), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭客户端连接</span></span><br><span class="line">    <span class="built_in">close</span>(client_fd);</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Closed connection on fd %d&quot;</span>, client_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> server_fd, new_socket;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="type">int</span> addrlen = <span class="built_in">sizeof</span>(address);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev, events[MAX_EVENTS]; <span class="comment">// epoll_event结构体用于描述事件</span></span><br><span class="line">    <span class="type">int</span> epollfd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建服务器监听套接字</span></span><br><span class="line">    server_fd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (server_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Socket creation failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setNonBlocking</span>(server_fd); <span class="comment">// 设置服务器套接字为非阻塞模式</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Socket created&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义地址并绑定</span></span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    address.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Bind failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(server_fd, <span class="number">3</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Listen failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Server listening on port %d&quot;</span>, PORT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setupRoutes</span>(); <span class="comment">// 设置路由表</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Routes set up&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建epoll实例</span></span><br><span class="line">    epollfd = <span class="built_in">epoll_create1</span>(<span class="number">0</span>); <span class="comment">// 创建一个新的epoll实例</span></span><br><span class="line">    <span class="keyword">if</span> (epollfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;epoll_create1 failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Epoll instance created with fd %d&quot;</span>, epollfd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置服务器套接字的epoll事件</span></span><br><span class="line">    ev.events = EPOLLIN | EPOLLET; <span class="comment">// 监听可读事件并启用边缘触发</span></span><br><span class="line">    ev.data.fd = server_fd; <span class="comment">// 关联服务器套接字</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, server_fd, &amp;ev) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Failed to add server_fd to epoll&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Server socket added to epoll instance&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主循环，等待事件发生并处理</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Waiting for events...&quot;</span>);</span><br><span class="line">        <span class="type">int</span> nfds = <span class="built_in">epoll_wait</span>(epollfd, events, MAX_EVENTS, <span class="number">-1</span>); <span class="comment">// 等待事件</span></span><br><span class="line">        <span class="keyword">if</span> (nfds == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;epoll_wait failed&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%d events ready&quot;</span>, nfds);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历发生事件的文件描述符</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n = <span class="number">0</span>; n &lt; nfds; ++n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (events[n].data.fd == server_fd) &#123;</span><br><span class="line">                <span class="comment">// 如果是服务器套接字，处理新的客户端连接</span></span><br><span class="line">                <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Server socket event triggered&quot;</span>);</span><br><span class="line">                <span class="keyword">while</span> ((new_socket = <span class="built_in">accept</span>(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;address, (<span class="type">socklen_t</span> *)&amp;addrlen)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">setNonBlocking</span>(new_socket); <span class="comment">// 设置客户端套接字为非阻塞</span></span><br><span class="line">                    ev.events = EPOLLIN | EPOLLET; <span class="comment">// 监听可读事件，启用边缘触发</span></span><br><span class="line">                    ev.data.fd = new_socket; <span class="comment">// 关联客户端套接字</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, new_socket, &amp;ev) == <span class="number">-1</span>) &#123;</span><br><span class="line">                        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Failed to add new socket to epoll&quot;</span>);</span><br><span class="line">                        <span class="built_in">close</span>(new_socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;New connection accepted: fd %d&quot;</span>, new_socket);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (new_socket == <span class="number">-1</span> &amp;&amp; errno != EAGAIN &amp;&amp; errno != EWOULDBLOCK) &#123;</span><br><span class="line">                    <span class="built_in">LOG_WARNING</span>(<span class="string">&quot;Accept returned error: %d&quot;</span>, errno);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果是客户端套接字，处理客户端请求</span></span><br><span class="line">                <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Handling client socket event: fd %d&quot;</span>, events[n].data.fd);</span><br><span class="line">                <span class="built_in">handleClientSocket</span>(events[n].data.fd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(server_fd); <span class="comment">// 关闭服务器套接字</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Server shutdown&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://yansmaoa.github.io">Ysmmm</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://yansmaoa.github.io/2025/03/25/myserver-helloword-epoll/">https://yansmaoa.github.io/2025/03/25/myserver-helloword-epoll/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yansmaoa.github.io" target="_blank">Ysmmm的快乐小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/server/">server</a></div><div class="post_share"><div class="social-share" data-image="/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/03/25/myserver-helloword-threadpool/" title="myserver-helloword-threadpool"><img class="cover" src="/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">myserver-helloword-threadpool</div></div></a></div><div class="next-post pull-right"><a href="/2025/03/24/myserver-helloword-database/" title="myserver-helloword-database"><img class="cover" src="/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">myserver-helloword-database</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/03/27/myserver-helloword-UI/" title="myserver-helloword-UI"><img class="cover" src="/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-27</div><div class="title">myserver-helloword-UI</div></div></a></div><div><a href="/2025/03/24/myserver-helloword-database/" title="myserver-helloword-database"><img class="cover" src="/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-24</div><div class="title">myserver-helloword-database</div></div></a></div><div><a href="/2025/03/24/myserver-helloword-logger/" title="myserver-helloword-logger"><img class="cover" src="/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-24</div><div class="title">myserver-helloword-logger</div></div></a></div><div><a href="/2025/03/25/myserver-helloword-threadpool/" title="myserver-helloword-threadpool"><img class="cover" src="/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-25</div><div class="title">myserver-helloword-threadpool</div></div></a></div><div><a href="/2025/03/24/myserver-helloword-http/" title="myserver-helloword-http"><img class="cover" src="/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-24</div><div class="title">myserver-helloword-http</div></div></a></div><div><a href="/2025/03/23/myserver-helloworld-helloword/" title="myserver-helloword-helloword"><img class="cover" src="/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-23</div><div class="title">myserver-helloword-helloword</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/saierda.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ysmmm</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">59</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/YANSMAoA"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=1850955441&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="https://github.com/YANSMAoA" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1850955441@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#I-O"><span class="toc-number">1.</span> <span class="toc-text">I&#x2F;O</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%89%E5%BE%85%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87%E5%B0%B1%E7%BB%AA%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">等待数据准备就绪：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E6%95%B0%E6%8D%AE%E4%BB%8E%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%A4%8D%E5%88%B6%E5%88%B0%E2%BD%A4%E2%BC%BE%E7%A9%BA%E9%97%B4%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">将数据从内核空间复制到⽤⼾空间：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I-O-%E6%93%8D%E4%BD%9C%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">I&#x2F;O 操作的整体流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E2%BD%85%E5%BC%8F%EF%BC%9A%E9%9B%B6%E6%8B%B7%E2%BB%89"><span class="toc-number">2.</span> <span class="toc-text">优化⽅式：零拷⻉</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E7%9B%98%E5%92%8C%E2%BD%B9%E7%BB%9C%E9%80%9F%E5%BA%A6%E6%85%A2%E4%BA%8E%E5%86%85%E5%AD%98%E5%92%8C-CPU%EF%BC%9A"><span class="toc-number">2.1.</span> <span class="toc-text">硬盘和⽹络速度慢于内存和 CPU：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E2%BD%90%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">对⽐分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">3.</span> <span class="toc-text">相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A5%97%E6%8E%A5%E5%AD%97-Socket-%EF%BC%9A"><span class="toc-number">3.1.</span> <span class="toc-text">套接字 (Socket)：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%B8%8A%E4%B8%8B%E2%BD%82%E5%88%87%E6%8D%A2%EF%BC%9A"><span class="toc-number">3.2.</span> <span class="toc-text">进程上下⽂切换：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E7%AE%A1%E7%90%86%EF%BC%9A"><span class="toc-number">3.3.</span> <span class="toc-text">缓冲区管理：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6%EF%BC%9A"><span class="toc-number">3.4.</span> <span class="toc-text">事件通知机制：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E2%BB%85%E7%9A%84%E4%BA%94%E7%A7%8DI-O%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.</span> <span class="toc-text">常⻅的五种I&#x2F;O模型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">事件驱动模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="toc-number">5.1.</span> <span class="toc-text">事件驱动模型定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E4%B8%8B%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.</span> <span class="toc-text">事件驱动下的服务器处理流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%B1%82%E2%BE%AF%E8%A7%A3%E9%87%8A%EF%BC%88%E9%87%8D%E8%A6%81%E7%90%86%E8%A7%A3%EF%BC%8C%E8%83%BD%E8%AE%B2%E6%B8%85%E6%A5%9A%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%89"><span class="toc-number">5.3.</span> <span class="toc-text">技术层⾯解释（重要理解，能讲清楚事件驱动的逻辑）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#epoll%E5%8E%9F%E7%90%86%E8%AF%A6%E7%BB%86%E8%A7%A3%E9%87%8A"><span class="toc-number">5.4.</span> <span class="toc-text">epoll原理详细解释</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%BD%A4%E2%BC%BE%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81"><span class="toc-number">5.4.1.</span> <span class="toc-text">⽤⼾态和内核态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epoll%E2%BC%AF%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">5.4.2.</span> <span class="toc-text">epoll⼯作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epoll%E7%9A%84%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.4.3.</span> <span class="toc-text">epoll的模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epoll-%E4%BD%BF%E2%BD%A4%E7%9A%84%E4%B8%BB%E8%A6%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A"><span class="toc-number">5.4.4.</span> <span class="toc-text">epoll 使⽤的主要数据结构：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#epoll%E5%AE%9E%E4%BE%8B%EF%BC%88%E7%90%86%E8%A7%A3-%E8%83%BD%E5%A4%8D%E8%BF%B0%EF%BC%89"><span class="toc-number">5.5.</span> <span class="toc-text">epoll实例（理解+能复述）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAepoll%E5%AE%9E%E4%BE%8B"><span class="toc-number">5.5.1.</span> <span class="toc-text">创建epoll实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E2%BE%AE%E9%98%BB%E5%A1%9Esocket"><span class="toc-number">5.5.2.</span> <span class="toc-text">设置⾮阻塞socket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%BA%8B%E4%BB%B6%E5%88%B0epoll"><span class="toc-number">5.5.3.</span> <span class="toc-text">注册事件到epoll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">5.5.4.</span> <span class="toc-text">事件循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">5.5.5.</span> <span class="toc-text">资源管理和错误处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">6.</span> <span class="toc-text">代码</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/27/myserver-helloword-UI/" title="myserver-helloword-UI">myserver-helloword-UI</a><time datetime="2025-03-27T05:34:24.000Z" title="发表于 2025-03-27 13:34:24">2025-03-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/25/myserver-helloword-threadpool/" title="myserver-helloword-threadpool">myserver-helloword-threadpool</a><time datetime="2025-03-25T08:16:34.000Z" title="发表于 2025-03-25 16:16:34">2025-03-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/25/myserver-helloword-epoll/" title="myserver-helloword-epoll">myserver-helloword-epoll</a><time datetime="2025-03-25T06:21:27.000Z" title="发表于 2025-03-25 14:21:27">2025-03-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/24/myserver-helloword-database/" title="myserver-helloword-database">myserver-helloword-database</a><time datetime="2025-03-24T13:37:00.000Z" title="发表于 2025-03-24 21:37:00">2025-03-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/24/myserver-helloword-logger/" title="myserver-helloword-logger">myserver-helloword-logger</a><time datetime="2025-03-24T03:21:34.000Z" title="发表于 2025-03-24 11:21:34">2025-03-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/v2-1cb481e27656b14e14b2878d6c47e544_r.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Ysmmm</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>